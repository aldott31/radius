<?xml version="1.0" encoding="UTF-8"?>
<odoo>

  <!-- ==================== LIST VIEW ==================== -->

  <record id="view_crm_city_list" model="ir.ui.view">
    <field name="name">crm.city.list</field>
    <field name="model">crm.city</field>
    <field name="arch" type="xml">
      <list string="Cities" decoration-muted="not active">
        <field name="name"/>
        <field name="code"/>
        <field name="pop_count"/>
        <field name="device_count"/>
        <field name="customer_count"/>
        <field name="company_id"/>
        <field name="active" column_invisible="1"/>
      </list>
    </field>
  </record>

  <!-- ==================== FORM VIEW ==================== -->

  <record id="view_crm_city_form" model="ir.ui.view">
    <field name="name">crm.city.form</field>
    <field name="model">crm.city</field>
    <field name="arch" type="xml">
      <form string="City">
        <sheet>

          <!-- Smart Buttons -->
          <div class="oe_button_box" name="button_box">
            <button type="object"
                    name="action_view_pops"
                    class="oe_stat_button"
                    icon="fa-building">
              <field name="pop_count" widget="statinfo" string="POPs"/>
            </button>

            <button type="object"
                    name="action_open_map"
                    class="oe_stat_button"
                    icon="fa-map-marker"
                    invisible="not latitude or not longitude">
              <div class="o_field_widget o_stat_info">
                <span class="o_stat_text">View on</span>
                <span class="o_stat_value">Map</span>
              </div>
            </button>

            <button type="object"
                    name="action_view_pops"
                    class="oe_stat_button"
                    icon="fa-server">
              <field name="device_count" widget="statinfo" string="Devices"/>
            </button>

            <button type="object"
                    name="action_view_pops"
                    class="oe_stat_button"
                    icon="fa-users">
              <field name="customer_count" widget="statinfo" string="Customers"/>
            </button>
          </div>

          <group col="2">
            <group string="City Information">
              <field name="name" placeholder="e.g., Tirana"/>
              <field name="code" placeholder="e.g., TIR"/>
              <field name="active"/>
            </group>

            <group string="Geolocation">
              <field name="latitude" placeholder="41.3275"/>
              <field name="longitude" placeholder="19.8187"/>
              <field name="company_id"/>
            </group>
          </group>

          <notebook>
            <page string="POPs">
              <field name="pop_ids" nolabel="1">
                <list>
                  <field name="name"/>
                  <field name="code"/>
                  <field name="pop_type"/>
                  <field name="operational_status"/>
                  <field name="device_count"/>
                  <field name="customer_count"/>
                </list>
              </field>
            </page>

            <page string="Notes">
              <field name="notes" nolabel="1" placeholder="Additional information about this city..."/>
            </page>
          </notebook>

        </sheet>

        <div class="oe_chatter">
          <field name="message_follower_ids"/>
          <field name="message_ids"/>
        </div>
      </form>
    </field>
  </record>

  <!-- ==================== SEARCH VIEW ==================== -->

  <record id="view_crm_city_search" model="ir.ui.view">
    <field name="name">crm.city.search</field>
    <field name="model">crm.city</field>
    <field name="arch" type="xml">
      <search string="Search Cities">
        <field name="name"/>
        <field name="code"/>

        <filter string="Active" name="active" domain="[('active', '=', True)]"/>
        <filter string="Archived" name="archived" domain="[('active', '=', False)]"/>

        <separator/>
        <!-- Has POPs: OK sepse One2many është searchable -->
        <filter string="Has POPs" name="has_pops" domain="[('pop_ids','!=',False)]"/>
         <filter string="Has Devices" name="has_devices"
                 domain="[('id','in', (0,))]" context="{'search_default_dummy':1}"/>

        <group expand="0" string="Group By">
          <filter string="Company" name="g_company" context="{'group_by': 'company_id'}"/>
        </group>
      </search>
    </field>
  </record>

  <!-- ==================== ACTION ==================== -->

  <record id="action_crm_city" model="ir.actions.act_window">
    <field name="name">Cities</field>
    <field name="res_model">crm.city</field>
    <field name="view_mode">list,form</field>
    <field name="context">{'search_default_active': 1}</field>
    <field name="help" type="html">
      <p class="o_view_nocontent_smiling_face">
        Add your first city
      </p>
      <p>
        Cities are the top level of your network infrastructure hierarchy.<br/>
        Each city can contain multiple POPs (Points of Presence).
      </p>
    </field>
  </record>

  <!-- ==================== MENU ITEM ==================== -->


  <menuitem id="menu_crm_cities"
            name="Cities"
            parent="radius_odoo_integration.menu_infrastructure"
            action="action_crm_city"
            groups="asr_radius_manager.group_isp_provisioning,asr_radius_manager.group_isp_field_tech,asr_radius_manager.group_isp_manager"
            sequence="10"/>

</odoo>