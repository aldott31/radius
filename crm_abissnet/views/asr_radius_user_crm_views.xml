<?xml version="1.0" encoding="UTF-8"?>
<odoo>

  <!-- ==================== FORM VIEW (Inherit) ==================== -->
  <record id="view_asr_radius_user_form_crm" model="ir.ui.view">
    <field name="name">asr.radius.user.form.crm</field>
    <field name="model">asr.radius.user</field>
    <field name="inherit_id" ref="asr_radius_manager.view_asr_radius_user_form"/>
    <field name="arch" type="xml">

      <!-- SLA ribbon -->
      <xpath expr="//form/sheet" position="before">
        <widget name="web_ribbon" title="ENTERPRISE" bg_color="text-bg-success"
                invisible="sla_level != '3'"/>
      </xpath>

      <!-- Butoni i hartës -->
      <xpath expr="//div[@name='button_box']" position="inside">
        <button type="object"
                name="action_open_map"
                class="oe_stat_button"
                icon="fa-map-marker"
                invisible="not partner_latitude or not partner_longitude">
          <div class="o_field_widget o_stat_info">
            <span class="o_stat_text">View on</span>
            <span class="o_stat_value">Map</span>
          </div>
        </button>
      </xpath>

      <!-- Zëvendëso grupin e parë -->
      <xpath expr="//sheet/group/group[1]" position="replace">
        <group string="Customer Info">
          <field name="name" placeholder="Customer name (optional)"/>
          <field name="username" placeholder="Auto-generated (445XXXXXX) - leave empty"/>
          <field name="radius_password" password="True" placeholder="Auto-generated - leave empty"/>
          <field name="sla_level" widget="badge" readonly="1"/>
          <field name="phone" widget="phone" placeholder="+355 69 123 4567"/>
          <field name="email" widget="email"/>
        </group>
      </xpath>

      <!-- Shto pas grupit të dytë - Address & Business Info -->
      <xpath expr="//sheet/group/group[2]" position="after">

        <!-- Address (compact) -->
        <group string="Installation Address">
          <field name="street" placeholder="Street address"/>
          <field name="city" placeholder="City"/>
          <field name="partner_latitude" placeholder="41.3275" string="Latitude"/>
          <field name="partner_longitude" placeholder="19.8187" string="Longitude"/>
        </group>

        <!-- Business Info -->
        <group string="Business Info">
          <field name="company_name" placeholder="Business name"/>
        </group>

      </xpath>

      <!-- Notebook Pages CRM -->
      <xpath expr="//notebook" position="inside">

        <!-- Installation & Network (unified tab) -->
        <page string="Installation &amp; Network">
          <group col="2">
            <group string="Network Location">
              <field name="access_device_id"
                     domain="[('company_id', '=', company_id), ('operational_status', '=', 'online')]"
                     options="{'no_create': True}"
                     context="{'tree_view_ref': 'crm_abissnet.view_crm_access_device_list'}"/>
              <field name="pop_id" readonly="1"/>
              <field name="city_id" readonly="1"/>
            </group>

            <group string="Installation">
              <field name="installation_date"/>
              <field name="installation_technician_id"/>
              <field name="contract_start_date"/>
            </group>
          </group>

          <separator string="ONU / Fiber Details"/>
          <group col="2">
            <group string="ONU Info">
              <field name="ont_serial" placeholder="HWTC12345678" string="ONU Serial"/>
              <field name="olt_pon_port" placeholder="Auto-filled from OLT"/>
              <field name="olt_ont_id" placeholder="e.g., 1, 2, 3..."/>
            </group>

            <group string="Fiber Path">
              <field name="fiber_closure_id"
                     domain="[('access_device_id', '=', access_device_id), ('operational_status', '=', 'active')]"
                     options="{'no_create': True}"/>
              <field name="fiber_core_number" readonly="1"/>
              <field name="fiber_color" readonly="1" widget="badge"/>
            </group>
          </group>

          <div class="alert alert-info" role="alert" invisible="not fiber_closure_id" style="margin-top: 10px;">
            <strong>Installation Path:</strong>
            OLT: <field name="access_device_id" readonly="1" nolabel="1"/>
            → Closure: <field name="fiber_closure_id" readonly="1" nolabel="1"/>
            → Core #<field name="fiber_core_number" readonly="1" nolabel="1"/>
            (<field name="fiber_color" readonly="1" nolabel="1" widget="badge"/>)
          </div>
        </page>

        <!-- Billing & Contract -->
        <page string="Billing &amp; Contract">
          <group col="2">
            <group string="Contract">
              <field name="contract_end_date"/>
              <field name="billing_day" help="Day of month to generate invoice (1-28)"/>
            </group>
            <group string="Notes">
              <field name="internal_notes" nolabel="1"
                     placeholder="Internal notes..."
                     widget="text"/>
            </group>
          </group>
        </page>

      </xpath>

    </field>
  </record>

  <!-- ==================== LIST VIEW (Inherit) ==================== -->
  <record id="view_asr_radius_user_list_crm" model="ir.ui.view">
    <field name="name">asr.radius.user.list.crm</field>
    <field name="model">asr.radius.user</field>
    <field name="inherit_id" ref="asr_radius_manager.view_asr_radius_user_list"/>
    <field name="arch" type="xml">

      <!-- Kolonat shtesë - vetëm essentials -->
      <xpath expr="//field[@name='name']" position="after">
        <field name="phone" optional="show"/>
        <field name="sla_level" optional="show" widget="badge"/>
        <field name="city" optional="hide"/>
        <field name="access_device_id" optional="hide"/>
      </xpath>

    </field>
  </record>

  <!-- ==================== SEARCH VIEW (Inherit) ==================== -->
  <record id="view_asr_radius_user_search_crm" model="ir.ui.view">
    <field name="name">asr.radius.user.search.crm</field>
    <field name="model">asr.radius.user</field>
    <field name="inherit_id" ref="asr_radius_manager.view_asr_radius_user_search"/>
    <field name="arch" type="xml">

      <xpath expr="//search" position="inside">
        <field name="phone"/>
        <field name="email"/>
        <field name="city"/>
        <field name="city_id" string="City (Infrastructure)"/>
        <field name="pop_id"/>
        <field name="access_device_id"/>

        <separator/>
        <filter string="Individual (SLA 1)" name="sla1" domain="[('sla_level','=','1')]"/>
        <filter string="Small Business (SLA 2)" name="sla2" domain="[('sla_level','=','2')]"/>
        <filter string="Enterprise (SLA 3)" name="sla3" domain="[('sla_level','=','3')]"/>

        <separator/>
        <filter string="Has Geolocation" name="has_geo"
                domain="[('partner_latitude','!=',False),('partner_longitude','!=',False)]"/>
        <filter string="Has Access Device" name="has_device" domain="[('access_device_id','!=',False)]"/>

        <group expand="0" string="Group By">
          <filter string="SLA Level" name="g_sla" context="{'group_by':'sla_level'}"/>
          <filter string="City" name="g_city" context="{'group_by':'city'}"/>
          <filter string="City (Infra)" name="g_city_infra" context="{'group_by':'city_id'}"/>
          <filter string="POP" name="g_pop" context="{'group_by':'pop_id'}"/>
          <filter string="Access Device" name="g_device" context="{'group_by':'access_device_id'}"/>
          <filter string="Installation Month" name="g_install" context="{'group_by':'installation_date:month'}"/>
        </group>
      </xpath>

    </field>
  </record>

  <!-- ==================== ACTION ==================== -->
  <record id="action_asr_radius_user_crm" model="ir.actions.act_window">
    <field name="name">Customers</field>
    <field name="res_model">asr.radius.user</field>
    <field name="view_mode">list,form</field> <!-- FIX: jo 'tree,form' -->
    <field name="context">{'search_default_active': 1}</field>
    <field name="domain">[]</field>
    <field name="help" type="html">
      <p class="o_view_nocontent_smiling_face">
        Add your first customer
      </p>
      <p>
        Customer records include contact info, SLA level, and geolocation.<br/>
        Technical RADIUS details are in the "Status" tab.
      </p>
    </field>
  </record>

  <!-- ==================== MENU ITEM ==================== -->
  <!-- DEPRECATED: Customers menu moved to ISP Management (radius_odoo_integration) -->
  <!--
  <menuitem id="menu_crm_customers"
            name="Customers"
            parent="menu_crm_abissnet_root"
            action="action_asr_radius_user_crm"
            groups="asr_radius_manager.group_isp_sales,asr_radius_manager.group_isp_customer_service,asr_radius_manager.group_isp_provisioning,asr_radius_manager.group_isp_field_tech,asr_radius_manager.group_isp_noc,asr_radius_manager.group_isp_finance,asr_radius_manager.group_isp_manager"
            sequence="10"/>
  -->
</odoo>