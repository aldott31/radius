<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!-- SIMPLIFIED ISP CUSTOMER FORM VIEW -->
    <record id="view_partner_form_isp_customer" model="ir.ui.view">
        <field name="name">res.partner.form.isp.customer</field>
        <field name="model">res.partner</field>
        <field name="inherit_id" ref="base.view_partner_form"/>
        <field name="priority">99</field>
        <field name="arch" type="xml">

            <!-- Add statusbar for customer lifecycle -->
            <xpath expr="//sheet" position="before">
                <header>
                    <field name="customer_status" widget="statusbar" statusbar_visible="lead,active,suspended,churned"
                           options="{'clickable': '1'}"/>
                </header>
            </xpath>

            <!-- Header: vendos label "Name:" para fushës së emrit -->
            <xpath expr="//div[hasclass('oe_title')]/h1" position="replace">
                <h1>
                    <span>Name: </span>
                    <field name="name" placeholder="e.g. Brandon Freeman"/>
                </h1>
            </xpath>

            <!-- Fshi grupin e parë default (Contact / Tax ID / Phone / Mobile / ...) -->
            <xpath expr="//sheet/group[1]" position="attributes">
                <attribute name="invisible">1</attribute>
            </xpath>

            <!-- Fshi disa fusha default -->
            <xpath expr="//field[@name='company_type']" position="attributes">
                <attribute name="invisible">1</attribute>
            </xpath>
            <xpath expr="//field[@name='parent_id']" position="attributes">
                <attribute name="invisible">1</attribute>
            </xpath>
            <xpath expr="//label[@for='street']" position="attributes">
                <attribute name="invisible">1</attribute>
            </xpath>
            <xpath expr="//div[@class='o_address_format']" position="attributes">
                <attribute name="invisible">1</attribute>
            </xpath>
            <xpath expr="//field[@name='category_id']" position="attributes">
                <attribute name="invisible">1</attribute>
            </xpath>

            <!-- Internal flag - load it invisibly -->
            <xpath expr="//field[@name='name']" position="before">
                <field name="is_radius_customer" invisible="1"/>
            </xpath>

            <!-- Hide is_radius_customer field if it appears anywhere else in the form -->
            <xpath expr="//field[@name='is_radius_customer']" position="attributes">
                <attribute name="invisible">1</attribute>
            </xpath>



            <!-- ACCOUNT PROFILE OVERVIEW -->
            <xpath expr="//div[hasclass('oe_title')]" position="after">

                <!-- Account Information Group -->
                <group string="Account Profile">
                    <group>
                        <label for="create_date" string="Account First Added"/>
                        <div>
                            <field name="create_date" readonly="1" class="oe_inline"/>
                        </div>
                        <label for="write_date" string="Account Last Update"/>
                        <div>
                            <field name="write_date" readonly="1" class="oe_inline"/>
                            <span class="ml8">from</span>
                            <field name="write_uid" readonly="1" class="oe_inline ml4"/>
                        </div>
                    </group>
                    <group>
                        <field name="description" placeholder="Additional customer information..." nolabel="1"/>
                    </group>
                </group>

                <!-- Contact Information -->
                <group string="Contact Information">
                    <group>
                        <field name="street" placeholder="e.g. Rruga e Kavajes"/>
                        <field name="street2" placeholder="Address line 2"/>
                        <field name="zip" placeholder="ZIP Code"/>
                        <field name="city" placeholder="e.g. Tirane"/>
                        <field name="country_id" options="{'no_create': True}"/>
                    </group>
                    <group>
                        <field name="mobile" placeholder="e.g. 0688602356"/>
                        <field name="phone" placeholder="Alternate phone"/>
                        <field name="email" placeholder="customer@example.com"/>
                        <field name="company_id" invisible="1"/>
                    </group>
                </group>

                <!-- Internet Service Status -->
                <group string="Internet Status">
                    <group>
                        <field name="customer_status" widget="badge"
                               decoration-success="customer_status == 'active'"
                               decoration-info="customer_status == 'lead'"
                               decoration-warning="customer_status == 'suspended'"
                               decoration-danger="customer_status == 'churned'"/>
                        <field name="subscription_id" options="{'no_create': True}" string="Plan Name"/>
                        <field name="pop_id" string="Technology (POP)"/>
                        <field name="city_id"/>
                    </group>
                    <group>
                        <field name="radius_username" readonly="1" string="RADIUS Username"/>
                        <field name="pppoe_status" widget="badge"
                               decoration-success="pppoe_status == 'up'"
                               decoration-muted="pppoe_status == 'down'"/>
                        <field name="current_framed_ip" string="IP Address"/>
                        <field name="sla_level"/>
                    </group>
                </group>

                <!-- Payment Information -->
                <group string="Payment Information">
                    <group>
                        <field name="last_payment_date"/>
                        <field name="service_paid_until"/>
                        <field name="last_payment_amount"/>
                        <field name="total_paid_amount"/>
                    </group>
                    <group>
                        <field name="first_payment_date"/>
                        <field name="payment_balance"/>
                        <field name="contract_start_date"/>
                        <field name="billing_day"/>
                    </group>
                    <group colspan="2">
                        <button name="action_refresh_payment_stats" type="object"
                                string="Refresh Payment Statistics"
                                class="btn-secondary"
                                icon="fa-refresh"
                                help="Manually update payment statistics from all paid invoices"/>
                    </group>
                </group>

                <!-- Referral/Links -->
                <group string="Referrals &amp; Links" invisible="not referral_code and not referred_by_id">
                    <group>
                        <field name="referral_code" placeholder="e.g. friends campaign code"/>
                        <field name="referred_by_id" options="{'no_create': True}"/>
                    </group>
                </group>

            </xpath>

        </field>
    </record>

    <!-- RADIUS PAGE -->
    <record id="view_partner_form_radius" model="ir.ui.view">
        <field name="name">res.partner.form.radius</field>
        <field name="model">res.partner</field>
        <field name="inherit_id" ref="base.view_partner_form"/>
        <field name="arch" type="xml">

            <!-- RESTRUCTURED RADIUS / ISP PAGE WITH ORGANIZED NOTEBOOKS -->
            <xpath expr="//notebook" position="inside">
                <page string="RADIUS / ISP">
                    <notebook>
                        <!-- PAGE 1: RADIUS CREDENTIALS & SYNC -->
                        <page string="RADIUS Credentials">
                            <group>
                                <group string="RADIUS Authentication">
                                    <field name="radius_username" readonly="radius_synced"/>
                                    <field name="radius_password" password="True" readonly="radius_synced"/>
                                    <field name="radius_synced" invisible="1"/>
                                    <field name="last_sync_date" readonly="1"/>
                                    <field name="last_sync_error" readonly="1" invisible="not last_sync_error"/>
                                    <field name="current_radius_group" readonly="1"/>
                                    <field name="is_suspended" readonly="1"/>
                                </group>
                                <group string="NAS Device">
                                    <field name="device_id"/>
                                </group>
                            </group>
                            <group string="Internal Notes">
                                <field name="internal_notes" nolabel="1" placeholder="Private notes for staff only..."/>
                            </group>
                            <group string="RADIUS Actions">
                                <button name="action_sync_to_radius" type="object"
                                        string="Sync to RADIUS"
                                        class="oe_highlight"
                                        invisible="not subscription_id"
                                        groups="asr_radius_manager.group_isp_provisioning,asr_radius_manager.group_isp_manager"/>
                                <button name="action_suspend" type="object"
                                        string="Suspend Customer"
                                        invisible="is_suspended"
                                        groups="asr_radius_manager.group_isp_finance,asr_radius_manager.group_isp_manager"/>
                                <button name="action_reactivate" type="object"
                                        string="Reactivate Customer"
                                        class="oe_highlight"
                                        invisible="not is_suspended"
                                        groups="asr_radius_manager.group_isp_finance,asr_radius_manager.group_isp_manager"/>
                                <button name="action_remove_from_radius" type="object"
                                        string="Remove from RADIUS"
                                        invisible="not radius_synced"
                                        groups="asr_radius_manager.group_isp_manager"/>
                            </group>
                        </page>

                        <!-- PAGE 2: NETWORK & INFRASTRUCTURE -->
                        <page string="Network &amp; Infrastructure">
                            <group>
                                <group string="Network Location">
                                    <field name="access_device_id"/>
                                    <field name="pop_id" readonly="1"/>
                                    <field name="city_id" readonly="1"/>
                                    <field name="olt_login_port"/>
                                </group>
                                <group string="Fiber Details">
                                    <field name="fiber_closure_id"/>
                                    <field name="fiber_core_number"/>
                                    <field name="fiber_color"/>
                                </group>
                            </group>
                            <group>
                                <group string="ONU/ONT Information">
                                    <field name="ont_serial"/>
                                    <field name="olt_pon_port"/>
                                    <field name="olt_ont_id"/>
                                </group>
                                <group/>
                            </group>
                            <group string="OLT Tools" invisible="not access_device_id">
                                <button type="action"
                                        name="%(asr_olt_telnet.action_open_olt_show_mac_wizard_from_device)d"
                                        string="Show MAC on OLT"
                                        icon="fa-search"
                                        context="{'default_olt_id': access_device_id}"
                                        groups="asr_radius_manager.group_isp_provisioning,asr_radius_manager.group_isp_noc,asr_radius_manager.group_isp_manager"/>
                                <button type="action"
                                        name="%(asr_olt_telnet.action_open_onu_uncfg_wizard)d"
                                        string="Unregistered ONUs"
                                        icon="fa-list"
                                        context="{'default_olt_id': access_device_id}"
                                        groups="asr_radius_manager.group_isp_provisioning,asr_radius_manager.group_isp_noc,asr_radius_manager.group_isp_manager"/>
                                <button type="action"
                                        name="%(asr_olt_telnet.action_olt_command_test_wizard)d"
                                        string="Test OLT Commands"
                                        icon="fa-terminal"
                                        context="{'default_olt_id': access_device_id}"
                                        groups="asr_radius_manager.group_isp_provisioning,asr_radius_manager.group_isp_noc,asr_radius_manager.group_isp_manager"/>
                            </group>
                        </page>

                        <!-- PAGE 3: INSTALLATION & LOCATION -->
                        <page string="Installation &amp; Location">
                            <group>
                                <group string="Installation Details">
                                    <field name="installation_date"/>
                                    <field name="installation_technician_id"/>
                                </group>
                                <group string="Geolocation">
                                    <field name="partner_latitude"/>
                                    <field name="partner_longitude"/>
                                    <button name="action_open_map" type="object"
                                            string="Open in Google Maps"
                                            icon="fa-map-marker"
                                            invisible="not partner_latitude or not partner_longitude"
                                            groups="asr_radius_manager.group_isp_field_tech,asr_radius_manager.group_isp_manager"/>
                                </group>
                            </group>
                            <group string="Customer Notes">
                                <field name="customer_notes" nolabel="1" placeholder="Notes visible to customer..."/>
                            </group>
                        </page>

                        <!-- PAGE 4: BILLING & CONTRACT -->
                        <page string="Billing &amp; Contract">
                            <group>
                                <group string="Contract Information">
                                    <field name="contract_start_date"/>
                                    <field name="contract_end_date"/>
                                </group>
                                <group string="Business Information" invisible="sla_level == '1'">
                                    <field name="is_business" invisible="1"/>
                                    <field name="nipt"/>
                                </group>
                            </group>
                        </page>

                        <!-- PAGE 5: SESSION HISTORY & MONITORING -->
                        <page string="Session History">
                            <group>
                                <group string="Current Session Details">
                                    <field name="last_session_start" readonly="1"/>
                                    <field name="current_interface" readonly="1"/>
                                </group>
                                <group string="Session Statistics">
                                    <field name="active_sessions_count" readonly="1"/>
                                    <field name="total_sessions_count" readonly="1"/>
                                </group>
                            </group>
                            <group string="Session Actions">
                                <button name="action_disconnect_user" type="object"
                                        string="Disconnect PPPoE Session"
                                        icon="fa-power-off"
                                        invisible="pppoe_status != 'up'"
                                        groups="asr_radius_manager.group_isp_noc,asr_radius_manager.group_isp_manager"/>
                                <button name="action_view_active_sessions" type="object"
                                        string="View Active Sessions"
                                        icon="fa-list"
                                        invisible="not active_sessions_count"
                                        groups="asr_radius_manager.group_isp_noc,asr_radius_manager.group_isp_manager"/>
                            </group>
                        </page>
                    </notebook>
                </page>
            </xpath>

        </field>
    </record>

    <!-- STAT BUTTONS -->
    <record id="view_partner_form_radius_stats" model="ir.ui.view">
        <field name="name">res.partner.form.radius.stats</field>
        <field name="model">res.partner</field>
        <field name="inherit_id" ref="base.view_partner_form"/>
        <field name="priority">98</field>
        <field name="arch" type="xml">
            <xpath expr="//div[@name='button_box']" position="inside">
                <button name="action_view_radius_user" type="object"
                        class="oe_stat_button" icon="fa-server"
                        invisible="not radius_user_id"
                        groups="asr_radius_manager.group_isp_provisioning,asr_radius_manager.group_isp_noc,asr_radius_manager.group_isp_manager">
                    <div class="o_field_widget o_stat_info">
                        <span class="o_stat_text">View in</span>
                        <span class="o_stat_value">RADIUS Manager</span>
                    </div>
                </button>

                <button name="action_view_active_sessions" type="object"
                        class="oe_stat_button" icon="fa-signal"
                        groups="asr_radius_manager.group_isp_noc,asr_radius_manager.group_isp_manager">
                    <field name="active_sessions_count" widget="statinfo" string="Active"/>
                </button>

                <button name="action_view_all_sessions" type="object"
                        class="oe_stat_button" icon="fa-history"
                        groups="asr_radius_manager.group_isp_noc,asr_radius_manager.group_isp_manager">
                    <field name="total_sessions_count" widget="statinfo" string="Sessions"/>
                </button>

                <button name="action_view_pppoe_status" type="object"
                        class="oe_stat_button" icon="fa-plug"
                        invisible="not radius_username"
                        groups="asr_radius_manager.group_isp_noc,asr_radius_manager.group_isp_manager">
                    <div class="o_field_widget o_stat_info">
                        <span class="o_stat_text">PPPoE</span>
                        <span class="o_stat_text">Status</span>
                    </div>
                    <field name="pppoe_status" widget="badge"
                           decoration-success="pppoe_status == 'up'"
                           decoration-muted="pppoe_status == 'down'"/>
                </button>

                <button name="action_view_sale_orders" type="object"
                        class="oe_stat_button" icon="fa-shopping-cart">
                    <field name="sale_order_count" widget="statinfo" string="Quotations"/>
                </button>

                <button name="action_view_invoices" type="object"
                        class="oe_stat_button" icon="fa-file-text-o">
                    <field name="invoice_count" widget="statinfo" string="Invoices"/>
                </button>
            </xpath>
        </field>
    </record>

    <!-- KANBAN VIEW FOR ISP CUSTOMERS -->
    <record id="view_partner_kanban_isp" model="ir.ui.view">
        <field name="name">res.partner.kanban.isp</field>
        <field name="model">res.partner</field>
        <field name="arch" type="xml">
            <kanban class="o_kanban_mobile">
                <field name="name"/>
                <field name="radius_username"/>
                <field name="subscription_id"/>
                <field name="pppoe_status"/>
                <field name="customer_status"/>
                <field name="city_id"/>
                <field name="sla_level"/>
                <templates>
                    <t t-name="kanban-box">
                        <div class="oe_kanban_global_click">
                            <div class="o_kanban_record_top">
                                <div class="o_kanban_record_headings">
                                    <strong class="o_kanban_record_title"><field name="name"/></strong>
                                    <span class="o_kanban_record_subtitle">
                                        <field name="radius_username"/>
                                    </span>
                                </div>
                                <span class="float-end">
                                    <span t-if="record.pppoe_status.raw_value == 'up'" class="badge text-bg-success">
                                        <i class="fa fa-circle"/> ONLINE
                                    </span>
                                    <span t-else="" class="badge text-bg-secondary">
                                        <i class="fa fa-circle-o"/> OFFLINE
                                    </span>
                                </span>
                            </div>
                            <div class="o_kanban_record_body">
                                <field name="subscription_id"/>
                                <div class="text-muted">
                                    <i class="fa fa-map-marker"/> <field name="city_id"/> |
                                    <span t-if="record.customer_status.raw_value == 'active'" class="text-success">Active</span>
                                    <span t-elif="record.customer_status.raw_value == 'lead'" class="text-info">Lead</span>
                                    <span t-elif="record.customer_status.raw_value == 'suspended'" class="text-warning">Suspended</span>
                                    <span t-else="" class="text-danger">Churned</span>
                                </div>
                            </div>
                        </div>
                    </t>
                </templates>
            </kanban>
        </field>
    </record>

    <!-- CALENDAR VIEW FOR INSTALLATIONS -->
    <record id="view_partner_calendar_installation" model="ir.ui.view">
        <field name="name">res.partner.calendar.installation</field>
        <field name="model">res.partner</field>
        <field name="arch" type="xml">
            <calendar string="Installation Schedule" date_start="installation_date"
                      color="installation_technician_id" mode="month">
                <field name="name"/>
                <field name="radius_username"/>
                <field name="installation_technician_id"/>
                <field name="subscription_id"/>
                <field name="access_device_id"/>
                <field name="city_id"/>
            </calendar>
        </field>
    </record>

    <!-- SEARCH FILTER -->
    <record id="view_partner_search_radius" model="ir.ui.view">
        <field name="name">res.partner.search.radius</field>
        <field name="model">res.partner</field>
        <field name="inherit_id" ref="base.view_res_partner_filter"/>
        <field name="arch" type="xml">
            <xpath expr="//search" position="inside">
                <filter string="RADIUS Customers" name="radius_customers" domain="[('is_radius_customer', '=', True)]"/>
                <filter string="Synced" name="synced" domain="[('is_radius_customer', '=', True), ('radius_synced', '=', True)]"/>
                <filter string="Not Synced" name="not_synced" domain="[('is_radius_customer', '=', True), ('radius_synced', '=', False)]"/>
                <filter string="Pending Installation" name="pending_installation" domain="[('installation_date', '!=', False), ('customer_status', '=', 'lead')]"/>
            </xpath>
        </field>
    </record>

    <!-- ACTION -->
    <record id="action_isp_customers_partner" model="ir.actions.act_window">
        <field name="name">Customers</field>
        <field name="res_model">res.partner</field>
        <field name="view_mode">kanban,list,form,calendar</field>
        <field name="context">{'search_default_radius_customers': 1, 'default_is_radius_customer': True}</field>
        <field name="domain">[]</field>
    </record>

    <!-- INSTALLATION CALENDAR ACTION -->
    <record id="action_installation_calendar" model="ir.actions.act_window">
        <field name="name">Installation Schedule</field>
        <field name="res_model">res.partner</field>
        <field name="view_mode">calendar,list,form</field>
        <field name="context">{'search_default_pending_installation': 1}</field>
        <field name="domain">[('installation_date', '!=', False)]</field>
    </record>

    <!-- MENU -->
    <menuitem id="menu_isp_customers"
              name="Customers"
              parent="crm_abissnet.menu_isp_management_root"
              action="action_isp_customers_partner"
              sequence="10"
              groups="asr_radius_manager.group_isp_sales,asr_radius_manager.group_isp_customer_service,asr_radius_manager.group_isp_provisioning,asr_radius_manager.group_isp_manager"/>

    <menuitem id="menu_installation_calendar"
              name="Installation Schedule"
              parent="crm_abissnet.menu_isp_management_root"
              action="action_installation_calendar"
              sequence="15"
              groups="asr_radius_manager.group_isp_field_tech,asr_radius_manager.group_isp_provisioning,asr_radius_manager.group_isp_manager"/>

</odoo>