<?xml version="1.0" encoding="UTF-8"?>
<odoo>

  <!-- LIST -->
  <record id="view_asr_subscription_list" model="ir.ui.view">
    <field name="name">asr.subscription.list</field>
    <field name="model">asr.subscription</field>
    <field name="arch" type="xml">
      <list string="Subscriptions"
            decoration-success="radius_synced"
            decoration-danger="not radius_synced">
        <field name="name"/>
        <field name="code"/>
        <field name="rate_limit"/>
        <field name="ip_pool_active"/>
        <field name="user_count"/>
        <field name="radius_synced" widget="boolean_toggle"/>
        <field name="last_sync_date"/>
        <field name="company_id" groups="base.group_multi_company"/>
      </list>
    </field>
  </record>

  <!-- FORM -->
  <record id="view_asr_subscription_form" model="ir.ui.view">
    <field name="name">asr.subscription.form</field>
    <field name="model">asr.subscription</field>
    <field name="arch" type="xml">
      <form string="Subscription Plan">
        <header>
          <button name="action_sync_attributes_to_radius"
                  type="object"
                  string="Sync to RADIUS"
                  class="oe_highlight"
                  groups="ab_radius_connector.group_ab_radius_admin"/>
          <button name="action_remove_from_radius"
                  type="object"
                  string="Remove from RADIUS"
                  class="oe_link"
                  groups="ab_radius_connector.group_ab_radius_admin"
                  invisible="not radius_synced"/>
          <button name="action_view_radius_info"
                  type="object"
                  string="Info"
                  class="oe_link"/>
        </header>

        <sheet>
          <!-- Smart Buttons -->
          <div class="oe_button_box" name="button_box">
            <button type="object"
                    name="action_view_radius_users"
                    class="oe_stat_button"
                    icon="fa-users">
              <field name="user_count" widget="statinfo" string="Users"/>
            </button>
          </div>

          <widget name="web_ribbon" title="Not Synced" bg_color="text-bg-danger"
                  invisible="radius_synced"/>
          <widget name="web_ribbon" title="Synced" bg_color="text-bg-success"
                  invisible="not radius_synced"/>

          <group>
            <group string="Plan Details">
              <field name="name" placeholder="e.g., 300M/300M Package"/>
              <field name="code" placeholder="Auto-filled from name"/>
              <field name="company_id" groups="base.group_multi_company"/>
            </group>
            <group string="Billing (Future Phase)">
                <field name="price"/>
                <field name="product_id"/>
            </group>
            <group string="Speed &amp; Pool">
              <field name="rate_limit" placeholder="e.g., 49M/49M or 300M/300M"/>
              <field name="ip_pool_active" placeholder="e.g., PPP-POOL-ACTIVE"/>
              <field name="ip_pool_expired" placeholder="e.g., PPP-POOL-EXPIRED"/>
            </group>
          </group>


          <notebook>

            <!-- ‚úÖ UPDATED: Correct Cisco AVPair Format -->
            <page string="RADIUS Attributes (Generated)">
              <group col="1">
                <div class="alert alert-info" role="alert">
                  <strong>üìã Auto-Generated from <code>rate_limit</code>:</strong>
                </div>
              </group>

              <group string="‚úÖ Current Format (ASR9k/IOS-XE Compatible)">
                <group col="1">
                  <div><strong>Cisco-AVPair</strong> := ip:interface-config=service-policy input [SPEED]M</div>
                  <div><strong>Cisco-AVPair</strong> := ip:interface-config=service-policy output [SPEED]M</div>
                  <div><strong>Framed-Pool</strong> := [ip_pool_active or PPP-POOL]</div>
                  <div><strong>Acct-Interim-Interval</strong> := [acct_interim_interval or 300]</div>
                  <div><strong>Idle-Timeout</strong> := 600</div>
                </group>
              </group>

              <group string="üìå Example">
                <group col="1">
                  <div class="text-muted">
                    <strong>Input:</strong> rate_limit = "49M/49M"<br/>
                    <strong>Output:</strong><br/>
                    ‚Ä¢ Cisco-AVPair := ip:interface-config=service-policy input 49M<br/>
                    ‚Ä¢ Cisco-AVPair := ip:interface-config=service-policy output 49M
                  </div>
                </group>
              </group>

              <group string="‚ÑπÔ∏è Notes">
                <group col="1">
                  <div class="text-muted">
                    <ul>
                      <li>Format parses "49M/49M" ‚Üí uses second value (download) as primary speed</li>
                      <li>Single values like "300M" are also supported</li>
                      <li>Session-Timeout is optional (set below if needed)</li>
                      <li>Custom attributes can override these (see Advanced tab)</li>
                    </ul>
                  </div>
                </group>
              </group>
            </page>

            <!-- Custom Attributes -->
            <page string="Custom Attributes">
              <field name="attribute_ids" nolabel="1">
                <list editable="bottom">
                  <field name="attribute" placeholder="e.g., Session-Timeout"/>
                  <field name="op" placeholder=":="/>
                  <field name="value" placeholder="Value"/>
                </list>
              </field>
              <div class="alert alert-warning" role="alert">
                ‚ö†Ô∏è Custom attributes override auto-generated ones.<br/>
                Use with caution.
              </div>
            </page>

            <!-- Advanced -->
            <page string="Advanced">
              <group string="Timers">
                <field name="session_timeout" placeholder="seconds (e.g., 3600)"/>
                <field name="acct_interim_interval" placeholder="default 300"/>
              </group>
            </page>

            <!-- Status -->
            <page string="Sync Status">
              <group>
                <group>
                  <field name="radius_synced" readonly="1"/>
                  <field name="last_sync_date" readonly="1"/>
                </group>
                <group>
                  <field name="user_count" readonly="1"/>
                </group>
              </group>
              <group string="Last Error" invisible="not last_sync_error">
                <field name="last_sync_error" nolabel="1" readonly="1" widget="text"/>
              </group>
            </page>

          </notebook>
        </sheet>

        <div class="oe_chatter">
          <field name="message_follower_ids"/>
          <field name="message_ids"/>
        </div>
      </form>
    </field>
  </record>

  <!-- Search -->
  <record id="view_asr_subscription_search" model="ir.ui.view">
    <field name="name">asr.subscription.search</field>
    <field name="model">asr.subscription</field>
    <field name="arch" type="xml">
      <search string="Search Subscriptions">
        <field name="name"/>
        <field name="code"/>
        <field name="rate_limit"/>

        <filter string="Synced" name="f_synced" domain="[('radius_synced','=',True)]"/>
        <filter string="Not Synced" name="f_nsynced" domain="[('radius_synced','=',False)]"/>
        <filter string="Has Errors" name="f_errors" domain="[('last_sync_error','!=',False)]"/>

        <group expand="0" string="Group By">
          <filter string="Company" name="g_company" context="{'group_by':'company_id'}"/>
          <filter string="Sync Status" name="g_synced" context="{'group_by':'radius_synced'}"/>
        </group>
      </search>
    </field>
  </record>

  <!-- Action -->
  <record id="action_asr_subscription" model="ir.actions.act_window">
    <field name="name">Subscriptions</field>
    <field name="res_model">asr.subscription</field>
    <field name="view_mode">list,form</field>
    <field name="help" type="html">
      <p class="o_view_nocontent_smiling_face">
        Create your first RADIUS service plan
      </p>
      <p>
        Define speed packages that sync to <code>radgroupreply</code>.<br/>
        Each plan generates Cisco AVPair attributes dynamically from <strong>rate_limit</strong>.
      </p>
    </field>
  </record>

  <menuitem id="menu_asr_subscriptions"
            name="Subscriptions"
            parent="menu_asr_radius_root"
            action="action_asr_subscription"
            sequence="20"/>

</odoo>